<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Ish Olami</title>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-gray-800 text-white">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <i class="fas fa-shield-alt text-2xl text-blue-400 mr-2"></i>
          <h1 class="text-2xl font-bold">Admin Panel</h1>
        </div>
        <div class="flex items-center space-x-4">
          <span id="adminName">Admin</span>
          <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
            <i class="fas fa-sign-out-alt mr-2"></i>Chiqish
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Stats Cards -->
    <div class="grid md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg p-6 shadow-sm">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100 text-blue-600">
            <i class="fas fa-users text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Jami foydalanuvchilar</p>
            <p id="totalUsers" class="text-2xl font-semibold text-gray-900">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-6 shadow-sm">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100 text-green-600">
            <i class="fas fa-briefcase text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Faol ishlar</p>
            <p id="activeJobs" class="text-2xl font-semibold text-gray-900">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-6 shadow-sm">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
            <i class="fas fa-file-alt text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Jami arizalar</p>
            <p id="totalApplications" class="text-2xl font-semibold text-gray-900">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-6 shadow-sm">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-purple-100 text-purple-600">
            <i class="fas fa-comments text-xl"></i>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">Faol chatlar</p>
            <p id="activeChats" class="text-2xl font-semibold text-gray-900">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Tabs -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6">
          <button onclick="switchAdminTab('users')" id="usersTab" class="py-4 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">
            <i class="fas fa-users mr-2"></i>Foydalanuvchilar
          </button>
          <button onclick="switchAdminTab('jobs')" id="jobsTab" class="py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
            <i class="fas fa-briefcase mr-2"></i>Ishlar
          </button>
          <button onclick="switchAdminTab('applications')" id="applicationsTab" class="py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
            <i class="fas fa-file-alt mr-2"></i>Arizalar
          </button>
          <button onclick="switchAdminTab('reports')" id="reportsTab" class="py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
            <i class="fas fa-chart-bar mr-2"></i>Hisobotlar
          </button>
        </nav>
      </div>

      <!-- Users Tab Content -->
      <div id="usersContent" class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold text-gray-900">Foydalanuvchilar boshqaruvi</h3>
          <div class="flex space-x-2">
            <input type="text" id="userSearch" placeholder="Foydalanuvchi qidirish..." class="p-2 border border-gray-300 rounded-lg">
            <select id="userRoleFilter" class="p-2 border border-gray-300 rounded-lg">
              <option value="">Barcha rollar</option>
              <option value="jobseeker">Ish izlovchi</option>
              <option value="employer">Ish beruvchi</option>
            </select>
          </div>
        </div>
        <div id="usersList" class="space-y-4">
          <!-- Users will be loaded here -->
        </div>
      </div>

      <!-- Jobs Tab Content -->
      <div id="jobsContent" class="p-6 hidden">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold text-gray-900">Ishlar boshqaruvi</h3>
          <div class="flex space-x-2">
            <input type="text" id="jobSearch" placeholder="Ish qidirish..." class="p-2 border border-gray-300 rounded-lg">
            <select id="jobStatusFilter" class="p-2 border border-gray-300 rounded-lg">
              <option value="">Barcha holatlar</option>
              <option value="active">Faol</option>
              <option value="inactive">Faol emas</option>
            </select>
          </div>
        </div>
        <div id="jobsList" class="space-y-4">
          <!-- Jobs will be loaded here -->
        </div>
      </div>

      <!-- Applications Tab Content -->
      <div id="applicationsContent" class="p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Arizalar boshqaruvi</h3>
        <div id="applicationsList" class="space-y-4">
          <!-- Applications will be loaded here -->
        </div>
      </div>

      <!-- Reports Tab Content -->
      <div id="reportsContent" class="p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Hisobotlar</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg p-6 shadow-sm">
            <h4 class="text-lg font-medium text-gray-900 mb-4">Foydalanuvchilar statistikasi</h4>
            <div id="userStats">
              <!-- User statistics will be loaded here -->
            </div>
          </div>
          <div class="bg-white rounded-lg p-6 shadow-sm">
            <h4 class="text-lg font-medium text-gray-900 mb-4">Ishlar statistikasi</h4>
            <div id="jobStats">
              <!-- Job statistics will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="firebase/firebase-config.js"></script>
  <script>
    // Admin System
    class AdminSystem {
      constructor() {
        this.currentUser = null;
        this.currentUserData = null;
        this.init();
      }

      init() {
        auth.onAuthStateChanged((user) => {
          if (user) {
            this.currentUser = user;
            this.loadUserData();
            this.checkAdminAccess();
          } else {
            window.location.href = 'index.html';
          }
        });
      }

      async loadUserData() {
        try {
          const userDoc = await db.collection('users').doc(this.currentUser.uid).get();
          if (userDoc.exists) {
            this.currentUserData = userDoc.data();
            this.updateUI();
            this.loadStats();
          }
        } catch (error) {
          console.error('Error loading user data:', error);
        }
      }

      async checkAdminAccess() {
        if (!this.currentUserData || this.currentUserData.role !== 'admin') {
          alert('Sizda admin huquqlari yo\'q!');
          window.location.href = 'dashboard.html';
        }
      }

      updateUI() {
        const adminName = document.getElementById('adminName');
        if (adminName && this.currentUserData) {
          adminName.textContent = this.currentUserData.name;
        }
      }

      async loadStats() {
        try {
          // Load users count
          const usersSnapshot = await db.collection('users').get();
          document.getElementById('totalUsers').textContent = usersSnapshot.size;

          // Load active jobs count
          const jobsSnapshot = await db.collection('jobs').where('status', '==', 'active').get();
          document.getElementById('activeJobs').textContent = jobsSnapshot.size;

          // Load applications count
          const applicationsSnapshot = await db.collection('applications').get();
          document.getElementById('totalApplications').textContent = applicationsSnapshot.size;

          // Load active chats count
          const chatsSnapshot = await db.collection('chats').get();
          document.getElementById('activeChats').textContent = chatsSnapshot.size;

          // Load initial data
          this.loadUsers();
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      async loadUsers() {
        try {
          const usersSnapshot = await db.collection('users').get();
          const users = usersSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          this.renderUsers(users);
        } catch (error) {
          console.error('Error loading users:', error);
        }
      }

      renderUsers(users) {
        const usersList = document.getElementById('usersList');
        if (!usersList) return;

        if (users.length === 0) {
          usersList.innerHTML = '<p class="text-gray-500 text-center py-8">Foydalanuvchilar topilmadi</p>';
          return;
        }

        usersList.innerHTML = users.map(user => `
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-blue-600"></i>
                </div>
                <div>
                  <h4 class="font-medium text-gray-900">${user.name}</h4>
                  <p class="text-sm text-gray-600">${user.email}</p>
                  <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${user.role === 'employer' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                    ${user.role === 'employer' ? 'Ish beruvchi' : 'Ish izlovchi'}
                  </span>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">Reyting: ${(user.rating || 0).toFixed(1)}</span>
                <button onclick="adminSystem.deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      async deleteUser(userId) {
        if (!confirm('Bu foydalanuvchini o\'chirishni xohlaysizmi?')) return;

        try {
          await db.collection('users').doc(userId).delete();
          this.showMessage('Foydalanuvchi muvaffaqiyatli o\'chirildi', 'success');
          this.loadUsers();
          this.loadStats();
        } catch (error) {
          console.error('Error deleting user:', error);
          this.showMessage('Xatolik yuz berdi', 'error');
        }
      }

      showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${this.getMessageClass(type)}`;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
          messageDiv.remove();
        }, 3000);
      }

      getMessageClass(type) {
        switch (type) {
          case 'success':
            return 'bg-green-100 text-green-700 border border-green-200';
          case 'error':
            return 'bg-red-100 text-red-700 border border-red-200';
          case 'warning':
            return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
          default:
            return 'bg-blue-100 text-blue-700 border border-blue-200';
        }
      }
    }

    // Initialize admin system
    const adminSystem = new AdminSystem();

    // Global functions
    function switchAdminTab(tabName) {
      // Hide all tab contents
      const tabContents = ['usersContent', 'jobsContent', 'applicationsContent', 'reportsContent'];
      tabContents.forEach(contentId => {
        const content = document.getElementById(contentId);
        if (content) {
          content.classList.add('hidden');
        }
      });

      // Remove active state from all tabs
      const tabButtons = ['usersTab', 'jobsTab', 'applicationsTab', 'reportsTab'];
      tabButtons.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.classList.remove('border-blue-500', 'text-blue-600');
          tab.classList.add('border-transparent', 'text-gray-500');
        }
      });

      // Show selected tab content
      const selectedContent = document.getElementById(tabName + 'Content');
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }

      // Add active state to selected tab
      const selectedTab = document.getElementById(tabName + 'Tab');
      if (selectedTab) {
        selectedTab.classList.remove('border-transparent', 'text-gray-500');
        selectedTab.classList.add('border-blue-500', 'text-blue-600');
      }
    }

    function logout() {
      if (confirm('Tizimdan chiqishni xohlaysizmi?')) {
        auth.signOut().then(() => {
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error('Error signing out:', error);
        });
      }
    }
  </script>
</body>
</html>
